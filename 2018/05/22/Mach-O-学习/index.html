<!DOCTYPE html>
<html>
<head>
    

    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?46bb8897dc1a51159a1db6b7c817ec00"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    
    
    
    <title>Mach-O 学习 | caozhenwei</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="">
    <meta name="description" content="Mach-O，是 Mach object 文件格式的缩写，同样也是 OS X 和 iOS 系统中可执行文件格式。类似于 Linux 下的 elf。除了可执行文件外，动态链接库、静态链接库等都是这种格式的。了解 Mach-O ，也助于我们更好的学习 iOS 逆向工程。">
<meta property="og:type" content="article">
<meta property="og:title" content="Mach-O 学习">
<meta property="og:url" content="https://github.com/caozhenwei/2018/05/22/Mach-O-学习/index.html">
<meta property="og:site_name" content="caozhenwei">
<meta property="og:description" content="Mach-O，是 Mach object 文件格式的缩写，同样也是 OS X 和 iOS 系统中可执行文件格式。类似于 Linux 下的 elf。除了可执行文件外，动态链接库、静态链接库等都是这种格式的。了解 Mach-O ，也助于我们更好的学习 iOS 逆向工程。">
<meta property="og:image" content="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20structure.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20preview.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20preview1.jpg">
<meta property="og:updated_time" content="2018-06-26T09:59:28.473Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mach-O 学习">
<meta name="twitter:description" content="Mach-O，是 Mach object 文件格式的缩写，同样也是 OS X 和 iOS 系统中可执行文件格式。类似于 Linux 下的 elf。除了可执行文件外，动态链接库、静态链接库等都是这种格式的。了解 Mach-O ，也助于我们更好的学习 iOS 逆向工程。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20structure.jpg">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/header_image_small.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">caozhenwei</h5>
          <a href="mailto:296614451@qq.com" title="296614451@qq.com" class="mail">296614451@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/caozhenwei" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Mach-O 学习</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Mach-O 学习</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-05-22T07:10:31.000Z" itemprop="datePublished" class="page-time">
  2018-05-22
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Mach-O-结构简单介绍"><span class="post-toc-number">1.</span> <span class="post-toc-text">Mach-O 结构简单介绍</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Mach-O-三部分结构详细介绍"><span class="post-toc-number">2.</span> <span class="post-toc-text">Mach-O 三部分结构详细介绍</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Header"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">Header</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#加载命令"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">加载命令</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Data"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">Data</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#MachOView"><span class="post-toc-number">3.</span> <span class="post-toc-text">MachOView</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#相关资料"><span class="post-toc-number">4.</span> <span class="post-toc-text">相关资料</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Mach-O-学习"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Mach-O 学习</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-05-22 15:10:31" datetime="2018-05-22T07:10:31.000Z"  itemprop="datePublished">2018-05-22</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>Mach-O，是 Mach object 文件格式的缩写，同样也是 OS X 和 iOS 系统中可执行文件格式。类似于 Linux 下的 elf。除了可执行文件外，动态链接库、静态链接库等都是这种格式的。了解 Mach-O ，也助于我们更好的学习 iOS 逆向工程。</p>
<a id="more"></a>
<h3 id="Mach-O-结构简单介绍"><a href="#Mach-O-结构简单介绍" class="headerlink" title="Mach-O 结构简单介绍"></a>Mach-O 结构简单介绍</h3><p>Mach-O 主要由三部分组成：<code>Header</code>、<code>Load commands</code>、<code>Raw segment data</code>，如下图所示：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20structure.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p><code>Header</code>保存了 Mach-O 的一些基本信息，包括了平台、文件类型、LoadCommands 的个数等等。</p>
<p><code>LoadCommands</code>这些指令非常清晰地指示加载器如何设置并且加载二进制数据，这一段紧跟 Header，加载 Mach-O 文件时会使用这里的数据来确定内存的分布。</p>
<p><code>Data</code> 每一个 segment 的具体数据都保存在这里，这里包含了具体的代码、数据等等。</p>
<h3 id="Mach-O-三部分结构详细介绍"><a href="#Mach-O-三部分结构详细介绍" class="headerlink" title="Mach-O 三部分结构详细介绍"></a>Mach-O 三部分结构详细介绍</h3><h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><p>我们可以用 <code>otool</code> 先来看看 iOS 中一个可执行文件的头信息，这里拿微信来看看，<code>otool -h WeChat</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ otool -h WeChat </span><br><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line"> 0xfeedface      12          9  0x00           2    86       8192 0x00218085</span><br><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line"> 0xfeedfacf 16777228          0  0x00           2    86       8984 0x00218085</span><br></pre></td></tr></table></figure>
<p>下面详细介绍下这都代表什么意思。</p>
<p>头信息的结构可以在 <code>/usr/include/mach-o/loader.h</code> 中查看</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The 32-bit mach header appears at the very beginning of the object file for</span></span><br><span class="line"><span class="comment"> * 32-bit architectures.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> mach_header &#123;</span><br><span class="line">	uint32_t	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	cpu_type_t	cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	cpu_subtype_t	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	uint32_t	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	uint32_t	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	uint32_t	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	uint32_t	flags;		<span class="comment">/* flags */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Constant for the magic field of the mach_header (32-bit architectures) */</span></span><br><span class="line"><span class="meta">#define	MH_MAGIC	0xfeedface	/* the mach magic number */</span></span><br><span class="line"><span class="meta">#define MH_CIGAM	0xcefaedfe	/* NXSwapInt(MH_MAGIC) */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The 64-bit mach header appears at the very beginning of object files for</span></span><br><span class="line"><span class="comment"> * 64-bit architectures.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> mach_header_64 &#123;</span><br><span class="line">	uint32_t	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	cpu_type_t	cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	cpu_subtype_t	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	uint32_t	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	uint32_t	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	uint32_t	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	uint32_t	flags;		<span class="comment">/* flags */</span></span><br><span class="line">	uint32_t	reserved;	<span class="comment">/* reserved */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Constant for the magic field of the mach_header_64 (64-bit architectures) */</span></span><br><span class="line"><span class="meta">#define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */</span></span><br><span class="line"><span class="meta">#define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */</span></span><br></pre></td></tr></table></figure>
<p>magic : 魔数<br>从上面的宏定义可以看出 0xfeedface 代表的是 32 位，0xfeedfacf 代表 64 位<br>cputype : cpu 的类型<br>在 /usr/include/mach/machine.h 中可以看到相关的定义</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> *	Machine types known by all.</span><br><span class="line"> */</span><br><span class="line"> </span><br><span class="line"><span class="comment">#define CPU_TYPE_ANY		((cpu_type_t) -1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define CPU_TYPE_VAX		((cpu_type_t) 1)</span></span><br><span class="line">/* skip				((cpu_type_t) 2)	*/</span><br><span class="line">/* skip				((cpu_type_t) 3)	*/</span><br><span class="line">/* skip				((cpu_type_t) 4)	*/</span><br><span class="line">/* skip				((cpu_type_t) 5)	*/</span><br><span class="line"><span class="comment">#define	CPU_TYPE_MC680x0	((cpu_type_t) 6)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_X86		((cpu_type_t) 7)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_I386		CPU_TYPE_X86		/* compatibility */</span></span><br><span class="line"><span class="comment">#define	CPU_TYPE_X86_64		(CPU_TYPE_X86 | CPU_ARCH_ABI64)</span></span><br><span class="line"></span><br><span class="line">/* skip CPU_TYPE_MIPS		((cpu_type_t) 8)	*/</span><br><span class="line">/* skip 			((cpu_type_t) 9)	*/</span><br><span class="line"><span class="comment">#define CPU_TYPE_MC98000	((cpu_type_t) 10)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_HPPA           ((cpu_type_t) 11)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_ARM		((cpu_type_t) 12)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_ARM64          (CPU_TYPE_ARM | CPU_ARCH_ABI64)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_MC88000	((cpu_type_t) 13)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_SPARC		((cpu_type_t) 14)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_I860		((cpu_type_t) 15)</span></span><br><span class="line">/* skip	CPU_TYPE_ALPHA		((cpu_type_t) 16)	*/</span><br><span class="line">/* skip				((cpu_type_t) 17)	*/</span><br><span class="line"><span class="comment">#define CPU_TYPE_POWERPC		((cpu_type_t) 18)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_POWERPC64		(CPU_TYPE_POWERPC | CPU_ARCH_ABI64)</span></span><br></pre></td></tr></table></figure>
<p>cupsubtype cpu 的子类型<br>和 cputype 一样，也可以在 /usr/include/mach/machine.h 中可以看到相关的定义，其中有关于 PowerPC 的，Mips 的等等，这里列一下关于 ARM 的:  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> *	ARM subtypes</span><br><span class="line"> */</span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_ALL             ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V4T             ((cpu_subtype_t) 5)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V6              ((cpu_subtype_t) 6)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V5TEJ           ((cpu_subtype_t) 7)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_XSCALE		((cpu_subtype_t) 8)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7		((cpu_subtype_t) 9)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7F		((cpu_subtype_t) 10) /* Cortex A9 */</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7S		((cpu_subtype_t) 11) /* Swift */</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7K		((cpu_subtype_t) 12)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V6M		((cpu_subtype_t) 14) /* Not meant to be run under xnu */</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7M		((cpu_subtype_t) 15) /* Not meant to be run under xnu */</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7EM		((cpu_subtype_t) 16) /* Not meant to be run under xnu */</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>filetype 文件的类型<br>相关定义在 /usr/include/mach-o/loader.h 中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#define	MH_OBJECT	0x1		/* relocatable object file */</span></span><br><span class="line"><span class="comment">#define	MH_EXECUTE	0x2		/* demand paged executable file */</span></span><br><span class="line"><span class="comment">#define	MH_FVMLIB	0x3		/* fixed VM shared library file */</span></span><br><span class="line"><span class="comment">#define	MH_CORE		0x4		/* core file */</span></span><br><span class="line"><span class="comment">#define	MH_PRELOAD	0x5		/* preloaded executable file */</span></span><br><span class="line"><span class="comment">#define	MH_DYLIB	0x6		/* dynamically bound shared library */</span></span><br><span class="line"><span class="comment">#define	MH_DYLINKER	0x7		/* dynamic link editor */</span></span><br><span class="line"><span class="comment">#define	MH_BUNDLE	0x8		/* dynamically bound bundle file */</span></span><br><span class="line"><span class="comment">#define	MH_DYLIB_STUB	0x9		/* shared library stub for static */</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<pre><code>常用的如下：
MH_OBJECT    编译过程中产生的 *.obj 文件
MH_EXECUTABLE    可执行二进制文件
MH_DYLIB    动态库
</code></pre><p>ncmds 指的是加载命令 (load commands) 的数量<br>sizeofcmds 表示 load commands 的总字节大小<br>flags 一个包含一组位标志的整数，它显示了 Mach-O 文件格式的某些可选特性的状态。</p>
<h4 id="加载命令"><a href="#加载命令" class="headerlink" title="加载命令"></a>加载命令</h4><p>这些加载命令在 Mach-O 文件加载解析时，被内核加载器或者动态链接器调用，指导如何设置加载对应的二进制数据段，加载命令的种类有很多种，在 /usr/include/mach-o/loader.h 头文件有简单的注释</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">struct load_command &#123;</span><br><span class="line">	uint32_t cmd;		/* <span class="built_in">type</span> of load <span class="built_in">command</span> */</span><br><span class="line">	uint32_t cmdsize;	/* total size of <span class="built_in">command</span> <span class="keyword">in</span> bytes */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * After MacOS X 10.1 when a new load <span class="built_in">command</span> is added that is required to be</span><br><span class="line"> * understood by the dynamic linker <span class="keyword">for</span> the image to execute properly the</span><br><span class="line"> * LC_REQ_DYLD bit will be or<span class="string">'ed into the load command constant.  If the dynamic</span></span><br><span class="line"><span class="string"> * linker sees such a load command it it does not understand will issue a</span></span><br><span class="line"><span class="string"> * "unknown load command required for execution" error and refuse to use the</span></span><br><span class="line"><span class="string"> * image.  Other load commands without this bit that are not understood will</span></span><br><span class="line"><span class="string"> * simply be ignored.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">#define LC_REQ_DYLD 0x80000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* Constants for the cmd field of all load commands, the type */</span></span><br><span class="line"><span class="string">#define	LC_SEGMENT	0x1	/* segment of this file to be mapped */</span></span><br><span class="line"><span class="string">#define	LC_SYMTAB	0x2	/* link-edit stab symbol table info */</span></span><br><span class="line"><span class="string">#define	LC_SYMSEG	0x3	/* link-edit gdb symbol table info (obsolete) */</span></span><br><span class="line"><span class="string">#define	LC_THREAD	0x4	/* thread */</span></span><br><span class="line"><span class="string">#define	LC_UNIXTHREAD	0x5	/* unix thread (includes a stack) */</span></span><br><span class="line"><span class="string">#define	LC_LOADFVMLIB	0x6	/* load a specified fixed VM shared library */</span></span><br><span class="line"><span class="string">#define	LC_IDFVMLIB	0x7	/* fixed VM shared library identification */</span></span><br><span class="line"><span class="string">#define	LC_IDENT	0x8	/* object identification info (obsolete) */</span></span><br><span class="line"><span class="string">#define LC_FVMFILE	0x9	/* fixed VM file inclusion (internal use) */</span></span><br><span class="line"><span class="string">#define LC_PREPAGE      0xa     /* prepage command (internal use) */</span></span><br><span class="line"><span class="string">#define	LC_DYSYMTAB	0xb	/* dynamic link-edit symbol table info */</span></span><br><span class="line"><span class="string">#define	LC_LOAD_DYLIB	0xc	/* load a dynamically linked shared library */</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>LC_SYMTAB    符号表地址</p>
<p>LC_DYSYMTAB    动态符号表地址</p>
<p>LC_LOAD_DYLINKER    使用何种动态加载库</p>
<p>LC_UUID    文件的唯一标识</p>
<p>LC_VERSION_MIN_MACOSX    二进制文件要求的最低操作系统版本</p>
<p>LC_SOURCE_VERSION    构建该二进制文件使用的源代码版本</p>
<p>LC_MAIN    设置程序主线程的入口地址和栈大小</p>
<p>通过 otool -lv 来查看一下 WeChat </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ otool -lv WeChat </span><br><span class="line">WeChat (architecture armv7):</span><br><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line">   MH_MAGIC     ARM         V7  0x00     EXECUTE    89       8292   NOUNDEFS DYLDLINK TWOLEVEL WEAK_DEFINES BINDS_TO_WEAK PIE</span><br><span class="line">Load <span class="built_in">command</span> 0</span><br><span class="line">      cmd LC_SEGMENT</span><br><span class="line">  cmdsize 56</span><br><span class="line">  segname __PAGEZERO</span><br><span class="line">   vmaddr 0x00000000</span><br><span class="line">   vmsize 0x00004000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 0</span><br><span class="line">  maxprot ---</span><br><span class="line"> initprot ---</span><br><span class="line">   nsects 0</span><br><span class="line">    flags (none)</span><br><span class="line">Load <span class="built_in">command</span> 1</span><br><span class="line">      cmd LC_SEGMENT</span><br><span class="line">  cmdsize 736</span><br><span class="line">  segname __TEXT</span><br><span class="line">   vmaddr 0x00004000</span><br><span class="line">   vmsize 0x034dc000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 55427072</span><br><span class="line">  maxprot r-x</span><br><span class="line"> initprot r-x</span><br><span class="line">   nsects 10</span><br><span class="line">    flags (none)</span><br><span class="line">Section</span><br><span class="line">  sectname __text</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000aff0</span><br><span class="line">      size 0x02d4bac4</span><br><span class="line">    offset 28656</span><br><span class="line">     align 2^4 (16)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      <span class="built_in">type</span> S_REGULAR</span><br><span class="line">attributes PURE_INSTRUCTIONS SOME_INSTRUCTIONS</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>其中每个 load command 的结构如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">struct segment_command &#123; /* <span class="keyword">for</span> 32-bit architectures */</span><br><span class="line">	uint32_t	cmd;		/* LC_SEGMENT */</span><br><span class="line">	uint32_t	cmdsize;	/* includes sizeof section structs */</span><br><span class="line">	char		segname[16];	/* segment name */</span><br><span class="line">	uint32_t	vmaddr;		/* memory address of this segment */</span><br><span class="line">	uint32_t	vmsize;		/* memory size of this segment */</span><br><span class="line">	uint32_t	fileoff;	/* file offset of this segment */</span><br><span class="line">	uint32_t	filesize;	/* amount to map from the file */</span><br><span class="line">	vm_prot_t	maxprot;	/* maximum VM protection */</span><br><span class="line">	vm_prot_t	initprot;	/* initial VM protection */</span><br><span class="line">	uint32_t	nsects;		/* number of sections <span class="keyword">in</span> segment */</span><br><span class="line">	uint32_t	flags;		/* flags */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * The 64-bit segment load <span class="built_in">command</span> indicates that a part of this file is to be</span><br><span class="line"> * mapped into a 64-bit task<span class="string">'s address space.  If the 64-bit segment has</span></span><br><span class="line"><span class="string"> * sections then section_64 structures directly follow the 64-bit segment</span></span><br><span class="line"><span class="string"> * command and their size is reflected in cmdsize.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">struct segment_command_64 &#123; /* for 64-bit architectures */</span></span><br><span class="line"><span class="string">	uint32_t	cmd;		/* LC_SEGMENT_64 */</span></span><br><span class="line"><span class="string">	uint32_t	cmdsize;	/* includes sizeof section_64 structs */</span></span><br><span class="line"><span class="string">	char		segname[16];	/* segment name */</span></span><br><span class="line"><span class="string">	uint64_t	vmaddr;		/* memory address of this segment */</span></span><br><span class="line"><span class="string">	uint64_t	vmsize;		/* memory size of this segment */</span></span><br><span class="line"><span class="string">	uint64_t	fileoff;	/* file offset of this segment */</span></span><br><span class="line"><span class="string">	uint64_t	filesize;	/* amount to map from the file */</span></span><br><span class="line"><span class="string">	vm_prot_t	maxprot;	/* maximum VM protection */</span></span><br><span class="line"><span class="string">	vm_prot_t	initprot;	/* initial VM protection */</span></span><br><span class="line"><span class="string">	uint32_t	nsects;		/* number of sections in segment */</span></span><br><span class="line"><span class="string">	uint32_t	flags;		/* flags */</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre></td></tr></table></figure>
<p>cmd 是 load command 的类型<br>cmdsize 代表 load command 的大小<br>segname 段名字<br>vmaddr 段的虚拟内存起始地址<br>vmsize 段的虚拟内存大小<br>fileoff 段在文件中的偏移量<br>filesize 段在文件中的大小<br>maxprot 段页面所需要的最高内存保护<br>initprot 段页面初始的内存保护<br>nsects 段中包含 section 的数量<br>flags 其他杂项标志位</p>
<h4 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h4><p>section 的机构如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">struct section &#123; /* <span class="keyword">for</span> 32-bit architectures */</span><br><span class="line">	char		sectname[16];	/* name of this section */</span><br><span class="line">	char		segname[16];	/* segment this section goes <span class="keyword">in</span> */</span><br><span class="line">	uint32_t	addr;		/* memory address of this section */</span><br><span class="line">	uint32_t	size;		/* size <span class="keyword">in</span> bytes of this section */</span><br><span class="line">	uint32_t	offset;		/* file offset of this section */</span><br><span class="line">	uint32_t	align;		/* section alignment (power of 2) */</span><br><span class="line">	uint32_t	reloff;		/* file offset of relocation entries */</span><br><span class="line">	uint32_t	nreloc;		/* number of relocation entries */</span><br><span class="line">	uint32_t	flags;		/* flags (section <span class="built_in">type</span> and attributes)*/</span><br><span class="line">	uint32_t	reserved1;	/* reserved (<span class="keyword">for</span> offset or index) */</span><br><span class="line">	uint32_t	reserved2;	/* reserved (<span class="keyword">for</span> count or sizeof) */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct section_64 &#123; /* <span class="keyword">for</span> 64-bit architectures */</span><br><span class="line">	char		sectname[16];	/* name of this section */</span><br><span class="line">	char		segname[16];	/* segment this section goes <span class="keyword">in</span> */</span><br><span class="line">	uint64_t	addr;		/* memory address of this section */</span><br><span class="line">	uint64_t	size;		/* size <span class="keyword">in</span> bytes of this section */</span><br><span class="line">	uint32_t	offset;		/* file offset of this section */</span><br><span class="line">	uint32_t	align;		/* section alignment (power of 2) */</span><br><span class="line">	uint32_t	reloff;		/* file offset of relocation entries */</span><br><span class="line">	uint32_t	nreloc;		/* number of relocation entries */</span><br><span class="line">	uint32_t	flags;		/* flags (section <span class="built_in">type</span> and attributes)*/</span><br><span class="line">	uint32_t	reserved1;	/* reserved (<span class="keyword">for</span> offset or index) */</span><br><span class="line">	uint32_t	reserved2;	/* reserved (<span class="keyword">for</span> count or sizeof) */</span><br><span class="line">	uint32_t	reserved3;	/* reserved */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>sectname section 名<br>segname 该 section 所属的 segment 名<br>addr 该 section 在内存的启始位置<br>size 该 section 的大小<br>offset 该 section 的文件偏移<br>align 字节大小对齐<br>reloff 重定位入口的文件偏移<br>nreloc 需要重定位的入口数量<br>flags 包含 section 的 type 和 attributes</p>
<p>可以通过 otool –s 查看某 segment 的某个 section：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ otool -s __TEXT __text WeChat</span><br><span class="line">WeChat (architecture armv7):</span><br><span class="line">Contents of (__TEXT,__text) section</span><br><span class="line">0000aff0	af03b5f0 8d04f84d f6444606 f2c070fe </span><br><span class="line">0000b000	f644304d 447871fc 314df2c0 46904479 </span><br><span class="line">0000b010	68096800 680c6800 8000f846 b9955935 </span><br><span class="line">0000b020	70e8f644 304df2c0 68004478 58306800</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="MachOView"><a href="#MachOView" class="headerlink" title="MachOView"></a>MachOView</h3><p>除了用 otool 查看 Mach-O 外，还可以通过 MachOView 可视化工具来查看<br>MachOView下载地址：<a href="http://sourceforge.net/projects/machoview/" target="_blank" rel="noopener">http://sourceforge.net/projects/machoview/</a><br>MachOView源码地址：<a href="https://github.com/gdbinit/MachOView">https://github.com/gdbinit/MachOView</a><br>效果如下：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20preview.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure><br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20preview1.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<h3 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h3><p><a href="https://github.com/caozhenwei/document/blob/master/Mach-O-File-Format.pdf">Mach-O-File-Format</a></p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        

        
        这里可以写作者留言，标签和 hexo 中所有变量及辅助函数等均可调用，示例：<a href="/2018/05/22/Mach-O-学习/" target="_blank" rel="external">https://github.com/caozhenwei/2018/05/22/Mach-O-学习/</a>
        
    </div>
    
    <footer>
        <a href="https://github.com/caozhenwei">
            <img src="/img/header_image_small.jpg" alt="caozhenwei">
            caozhenwei
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/&title=《Mach-O 学习》 — caozhenwei&pic=https://github.com/caozhenwei/img/header_image_small.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/&title=《Mach-O 学习》 — caozhenwei&source=Mach-O，是 Mach object 文件格式的缩写，同样也是 OS X 和 iOS 系统中可执行文件格式。类似于 Linux 下的 elf。除了可执..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Mach-O 学习》 — caozhenwei&url=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/&via=https://github.com/caozhenwei" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/05/24/Logos-语法/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Logos 语法</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/04/20/CSS学习之盒子模型/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">CSS学习之盒子模型</h4>
      </a>
    </div>
  
</nav>



    

















<section class="comments" id="comments">
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
        var id = location.pathname
        if (location.pathname.length > 50) {
          id = location.pathname.replace(/\/\d+\/\d+\/\d+\//, '').replace('/', '').substring(0, 50)
        }
        const gitalk = new Gitalk({
          clientID: 'bb8a9564b2162d91f724',
          clientSecret: '107d88e606e42610448a122b5bda41b95e09abc9',
          repo: 'caozhenwei.github.io',
          owner: 'caozhenwei',
          admin: ['caozhenwei'],
          id: id,      // Ensure uniqueness and length less than 50
          title: document.title.split('|')[0],
          distractionFreeMode: false  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>
</section>




</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <!-- <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>caozhenwei &copy; 2015 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>
 -->
    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/&title=《Mach-O 学习》 — caozhenwei&pic=https://github.com/caozhenwei/img/header_image_small.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/&title=《Mach-O 学习》 — caozhenwei&source=Mach-O，是 Mach object 文件格式的缩写，同样也是 OS X 和 iOS 系统中可执行文件格式。类似于 Linux 下的 elf。除了可执..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Mach-O 学习》 — caozhenwei&url=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/&via=https://github.com/caozhenwei" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://github.com/caozhenwei/2018/05/22/Mach-O-学习/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'caozhenwei';
            clearTimeout(titleTime);
        } else {
            document.title = 'caozhenwei';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
