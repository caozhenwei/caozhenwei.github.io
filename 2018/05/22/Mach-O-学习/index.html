<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">

  
  <script src="/js/script.js"></script>
  

  <title>caozhenwei</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/bootstrap.css" >
</head>
  <body>
    <header class="header-content">
<div class="header">
  <div class="blog-title">
    <img class="logo" src="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/header_image_small.jpeg">
    <a href="/" class="title">caozhenwei</a>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/archives" class="menu-item-link">Archives</a>
        </li>
      
    </ul>
  </nav>
</div>
</header>
    <main class="main">
      <div class="content">
  <article class="article">
    <div class="article-detail">
      <!-- 标题 -->
      <div class="article-title">
        <h2 class="title">Mach-O 学习</h2>
      </div>

      <!-- 时间 -->
      <div class="article-meta">
        <span class="article-time">2018-05-22</span>
      </div>

      <!-- 文章内容 -->
      <div class="article-content">
        <p>Mach-O，是 Mach object 文件格式的缩写，同样也是 OS X 和 iOS 系统中可执行文件格式。类似于 Linux 下的 elf。除了可执行文件外，动态链接库、静态链接库等都是这种格式的。了解 Mach-O ，也助于我们更好的学习 iOS 逆向工程。</p>
<a id="more"></a>
<h3 id="Mach-O-结构简单介绍"><a href="#Mach-O-结构简单介绍" class="headerlink" title="Mach-O 结构简单介绍"></a>Mach-O 结构简单介绍</h3><p>Mach-O 主要由三部分组成：<code>Header</code>、<code>Load commands</code>、<code>Raw segment data</code>，如下图所示：<br><img src="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20structure.jpg" alt=""></p>
<p><code>Header</code>保存了 Mach-O 的一些基本信息，包括了平台、文件类型、LoadCommands 的个数等等。</p>
<p><code>LoadCommands</code>这些指令非常清晰地指示加载器如何设置并且加载二进制数据，这一段紧跟 Header，加载 Mach-O 文件时会使用这里的数据来确定内存的分布。</p>
<p><code>Data</code> 每一个 segment 的具体数据都保存在这里，这里包含了具体的代码、数据等等。</p>
<h3 id="Mach-O-三部分结构详细介绍"><a href="#Mach-O-三部分结构详细介绍" class="headerlink" title="Mach-O 三部分结构详细介绍"></a>Mach-O 三部分结构详细介绍</h3><h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><p>我们可以用 <code>otool</code> 先来看看 iOS 中一个可执行文件的头信息，这里拿微信来看看，<code>otool -h WeChat</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ otool -h WeChat </span><br><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line"> 0xfeedface      12          9  0x00           2    86       8192 0x00218085</span><br><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line"> 0xfeedfacf 16777228          0  0x00           2    86       8984 0x00218085</span><br></pre></td></tr></table></figure>
<p>下面详细介绍下这都代表什么意思。</p>
<p>头信息的结构可以在 <code>/usr/include/mach-o/loader.h</code> 中查看</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The 32-bit mach header appears at the very beginning of the object file for</span></span><br><span class="line"><span class="comment"> * 32-bit architectures.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> mach_header &#123;</span><br><span class="line">	uint32_t	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	cpu_type_t	cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	cpu_subtype_t	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	uint32_t	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	uint32_t	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	uint32_t	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	uint32_t	flags;		<span class="comment">/* flags */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Constant for the magic field of the mach_header (32-bit architectures) */</span></span><br><span class="line"><span class="meta">#define	MH_MAGIC	0xfeedface	/* the mach magic number */</span></span><br><span class="line"><span class="meta">#define MH_CIGAM	0xcefaedfe	/* NXSwapInt(MH_MAGIC) */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The 64-bit mach header appears at the very beginning of object files for</span></span><br><span class="line"><span class="comment"> * 64-bit architectures.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> mach_header_64 &#123;</span><br><span class="line">	uint32_t	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	cpu_type_t	cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	cpu_subtype_t	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	uint32_t	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	uint32_t	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	uint32_t	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	uint32_t	flags;		<span class="comment">/* flags */</span></span><br><span class="line">	uint32_t	reserved;	<span class="comment">/* reserved */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Constant for the magic field of the mach_header_64 (64-bit architectures) */</span></span><br><span class="line"><span class="meta">#define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */</span></span><br><span class="line"><span class="meta">#define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */</span></span><br></pre></td></tr></table></figure>
<p>magic : 魔数<br>从上面的宏定义可以看出 0xfeedface 代表的是 32 位，0xfeedfacf 代表 64 位<br>cputype : cpu 的类型<br>在 /usr/include/mach/machine.h 中可以看到相关的定义</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> *	Machine types known by all.</span><br><span class="line"> */</span><br><span class="line"> </span><br><span class="line"><span class="comment">#define CPU_TYPE_ANY		((cpu_type_t) -1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define CPU_TYPE_VAX		((cpu_type_t) 1)</span></span><br><span class="line">/* skip				((cpu_type_t) 2)	*/</span><br><span class="line">/* skip				((cpu_type_t) 3)	*/</span><br><span class="line">/* skip				((cpu_type_t) 4)	*/</span><br><span class="line">/* skip				((cpu_type_t) 5)	*/</span><br><span class="line"><span class="comment">#define	CPU_TYPE_MC680x0	((cpu_type_t) 6)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_X86		((cpu_type_t) 7)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_I386		CPU_TYPE_X86		/* compatibility */</span></span><br><span class="line"><span class="comment">#define	CPU_TYPE_X86_64		(CPU_TYPE_X86 | CPU_ARCH_ABI64)</span></span><br><span class="line"></span><br><span class="line">/* skip CPU_TYPE_MIPS		((cpu_type_t) 8)	*/</span><br><span class="line">/* skip 			((cpu_type_t) 9)	*/</span><br><span class="line"><span class="comment">#define CPU_TYPE_MC98000	((cpu_type_t) 10)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_HPPA           ((cpu_type_t) 11)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_ARM		((cpu_type_t) 12)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_ARM64          (CPU_TYPE_ARM | CPU_ARCH_ABI64)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_MC88000	((cpu_type_t) 13)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_SPARC		((cpu_type_t) 14)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_I860		((cpu_type_t) 15)</span></span><br><span class="line">/* skip	CPU_TYPE_ALPHA		((cpu_type_t) 16)	*/</span><br><span class="line">/* skip				((cpu_type_t) 17)	*/</span><br><span class="line"><span class="comment">#define CPU_TYPE_POWERPC		((cpu_type_t) 18)</span></span><br><span class="line"><span class="comment">#define CPU_TYPE_POWERPC64		(CPU_TYPE_POWERPC | CPU_ARCH_ABI64)</span></span><br></pre></td></tr></table></figure>
<p>cupsubtype cpu 的子类型<br>和 cputype 一样，也可以在 /usr/include/mach/machine.h 中可以看到相关的定义，其中有关于 PowerPC 的，Mips 的等等，这里列一下关于 ARM 的:  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> *	ARM subtypes</span><br><span class="line"> */</span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_ALL             ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V4T             ((cpu_subtype_t) 5)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V6              ((cpu_subtype_t) 6)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V5TEJ           ((cpu_subtype_t) 7)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_XSCALE		((cpu_subtype_t) 8)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7		((cpu_subtype_t) 9)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7F		((cpu_subtype_t) 10) /* Cortex A9 */</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7S		((cpu_subtype_t) 11) /* Swift */</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7K		((cpu_subtype_t) 12)</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V6M		((cpu_subtype_t) 14) /* Not meant to be run under xnu */</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7M		((cpu_subtype_t) 15) /* Not meant to be run under xnu */</span></span><br><span class="line"><span class="comment">#define CPU_SUBTYPE_ARM_V7EM		((cpu_subtype_t) 16) /* Not meant to be run under xnu */</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>filetype 文件的类型<br>相关定义在 /usr/include/mach-o/loader.h 中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#define	MH_OBJECT	0x1		/* relocatable object file */</span></span><br><span class="line"><span class="comment">#define	MH_EXECUTE	0x2		/* demand paged executable file */</span></span><br><span class="line"><span class="comment">#define	MH_FVMLIB	0x3		/* fixed VM shared library file */</span></span><br><span class="line"><span class="comment">#define	MH_CORE		0x4		/* core file */</span></span><br><span class="line"><span class="comment">#define	MH_PRELOAD	0x5		/* preloaded executable file */</span></span><br><span class="line"><span class="comment">#define	MH_DYLIB	0x6		/* dynamically bound shared library */</span></span><br><span class="line"><span class="comment">#define	MH_DYLINKER	0x7		/* dynamic link editor */</span></span><br><span class="line"><span class="comment">#define	MH_BUNDLE	0x8		/* dynamically bound bundle file */</span></span><br><span class="line"><span class="comment">#define	MH_DYLIB_STUB	0x9		/* shared library stub for static */</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<pre><code>常用的如下：
MH_OBJECT    编译过程中产生的 *.obj 文件
MH_EXECUTABLE    可执行二进制文件
MH_DYLIB    动态库
</code></pre><p>ncmds 指的是加载命令 (load commands) 的数量<br>sizeofcmds 表示 load commands 的总字节大小<br>flags 一个包含一组位标志的整数，它显示了 Mach-O 文件格式的某些可选特性的状态。</p>
<h4 id="加载命令"><a href="#加载命令" class="headerlink" title="加载命令"></a>加载命令</h4><p>这些加载命令在 Mach-O 文件加载解析时，被内核加载器或者动态链接器调用，指导如何设置加载对应的二进制数据段，加载命令的种类有很多种，在 /usr/include/mach-o/loader.h 头文件有简单的注释</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">struct load_command &#123;</span><br><span class="line">	uint32_t cmd;		/* <span class="built_in">type</span> of load <span class="built_in">command</span> */</span><br><span class="line">	uint32_t cmdsize;	/* total size of <span class="built_in">command</span> <span class="keyword">in</span> bytes */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * After MacOS X 10.1 when a new load <span class="built_in">command</span> is added that is required to be</span><br><span class="line"> * understood by the dynamic linker <span class="keyword">for</span> the image to execute properly the</span><br><span class="line"> * LC_REQ_DYLD bit will be or<span class="string">'ed into the load command constant.  If the dynamic</span></span><br><span class="line"><span class="string"> * linker sees such a load command it it does not understand will issue a</span></span><br><span class="line"><span class="string"> * "unknown load command required for execution" error and refuse to use the</span></span><br><span class="line"><span class="string"> * image.  Other load commands without this bit that are not understood will</span></span><br><span class="line"><span class="string"> * simply be ignored.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">#define LC_REQ_DYLD 0x80000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* Constants for the cmd field of all load commands, the type */</span></span><br><span class="line"><span class="string">#define	LC_SEGMENT	0x1	/* segment of this file to be mapped */</span></span><br><span class="line"><span class="string">#define	LC_SYMTAB	0x2	/* link-edit stab symbol table info */</span></span><br><span class="line"><span class="string">#define	LC_SYMSEG	0x3	/* link-edit gdb symbol table info (obsolete) */</span></span><br><span class="line"><span class="string">#define	LC_THREAD	0x4	/* thread */</span></span><br><span class="line"><span class="string">#define	LC_UNIXTHREAD	0x5	/* unix thread (includes a stack) */</span></span><br><span class="line"><span class="string">#define	LC_LOADFVMLIB	0x6	/* load a specified fixed VM shared library */</span></span><br><span class="line"><span class="string">#define	LC_IDFVMLIB	0x7	/* fixed VM shared library identification */</span></span><br><span class="line"><span class="string">#define	LC_IDENT	0x8	/* object identification info (obsolete) */</span></span><br><span class="line"><span class="string">#define LC_FVMFILE	0x9	/* fixed VM file inclusion (internal use) */</span></span><br><span class="line"><span class="string">#define LC_PREPAGE      0xa     /* prepage command (internal use) */</span></span><br><span class="line"><span class="string">#define	LC_DYSYMTAB	0xb	/* dynamic link-edit symbol table info */</span></span><br><span class="line"><span class="string">#define	LC_LOAD_DYLIB	0xc	/* load a dynamically linked shared library */</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>LC_SYMTAB    符号表地址</p>
<p>LC_DYSYMTAB    动态符号表地址</p>
<p>LC_LOAD_DYLINKER    使用何种动态加载库</p>
<p>LC_UUID    文件的唯一标识</p>
<p>LC_VERSION_MIN_MACOSX    二进制文件要求的最低操作系统版本</p>
<p>LC_SOURCE_VERSION    构建该二进制文件使用的源代码版本</p>
<p>LC_MAIN    设置程序主线程的入口地址和栈大小</p>
<p>通过 otool -lv 来查看一下 WeChat </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ otool -lv WeChat </span><br><span class="line">WeChat (architecture armv7):</span><br><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line">   MH_MAGIC     ARM         V7  0x00     EXECUTE    89       8292   NOUNDEFS DYLDLINK TWOLEVEL WEAK_DEFINES BINDS_TO_WEAK PIE</span><br><span class="line">Load <span class="built_in">command</span> 0</span><br><span class="line">      cmd LC_SEGMENT</span><br><span class="line">  cmdsize 56</span><br><span class="line">  segname __PAGEZERO</span><br><span class="line">   vmaddr 0x00000000</span><br><span class="line">   vmsize 0x00004000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 0</span><br><span class="line">  maxprot ---</span><br><span class="line"> initprot ---</span><br><span class="line">   nsects 0</span><br><span class="line">    flags (none)</span><br><span class="line">Load <span class="built_in">command</span> 1</span><br><span class="line">      cmd LC_SEGMENT</span><br><span class="line">  cmdsize 736</span><br><span class="line">  segname __TEXT</span><br><span class="line">   vmaddr 0x00004000</span><br><span class="line">   vmsize 0x034dc000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 55427072</span><br><span class="line">  maxprot r-x</span><br><span class="line"> initprot r-x</span><br><span class="line">   nsects 10</span><br><span class="line">    flags (none)</span><br><span class="line">Section</span><br><span class="line">  sectname __text</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000aff0</span><br><span class="line">      size 0x02d4bac4</span><br><span class="line">    offset 28656</span><br><span class="line">     align 2^4 (16)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      <span class="built_in">type</span> S_REGULAR</span><br><span class="line">attributes PURE_INSTRUCTIONS SOME_INSTRUCTIONS</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>其中每个 load command 的结构如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">struct segment_command &#123; /* <span class="keyword">for</span> 32-bit architectures */</span><br><span class="line">	uint32_t	cmd;		/* LC_SEGMENT */</span><br><span class="line">	uint32_t	cmdsize;	/* includes sizeof section structs */</span><br><span class="line">	char		segname[16];	/* segment name */</span><br><span class="line">	uint32_t	vmaddr;		/* memory address of this segment */</span><br><span class="line">	uint32_t	vmsize;		/* memory size of this segment */</span><br><span class="line">	uint32_t	fileoff;	/* file offset of this segment */</span><br><span class="line">	uint32_t	filesize;	/* amount to map from the file */</span><br><span class="line">	vm_prot_t	maxprot;	/* maximum VM protection */</span><br><span class="line">	vm_prot_t	initprot;	/* initial VM protection */</span><br><span class="line">	uint32_t	nsects;		/* number of sections <span class="keyword">in</span> segment */</span><br><span class="line">	uint32_t	flags;		/* flags */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * The 64-bit segment load <span class="built_in">command</span> indicates that a part of this file is to be</span><br><span class="line"> * mapped into a 64-bit task<span class="string">'s address space.  If the 64-bit segment has</span></span><br><span class="line"><span class="string"> * sections then section_64 structures directly follow the 64-bit segment</span></span><br><span class="line"><span class="string"> * command and their size is reflected in cmdsize.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">struct segment_command_64 &#123; /* for 64-bit architectures */</span></span><br><span class="line"><span class="string">	uint32_t	cmd;		/* LC_SEGMENT_64 */</span></span><br><span class="line"><span class="string">	uint32_t	cmdsize;	/* includes sizeof section_64 structs */</span></span><br><span class="line"><span class="string">	char		segname[16];	/* segment name */</span></span><br><span class="line"><span class="string">	uint64_t	vmaddr;		/* memory address of this segment */</span></span><br><span class="line"><span class="string">	uint64_t	vmsize;		/* memory size of this segment */</span></span><br><span class="line"><span class="string">	uint64_t	fileoff;	/* file offset of this segment */</span></span><br><span class="line"><span class="string">	uint64_t	filesize;	/* amount to map from the file */</span></span><br><span class="line"><span class="string">	vm_prot_t	maxprot;	/* maximum VM protection */</span></span><br><span class="line"><span class="string">	vm_prot_t	initprot;	/* initial VM protection */</span></span><br><span class="line"><span class="string">	uint32_t	nsects;		/* number of sections in segment */</span></span><br><span class="line"><span class="string">	uint32_t	flags;		/* flags */</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre></td></tr></table></figure>
<p>cmd 是 load command 的类型<br>cmdsize 代表 load command 的大小<br>segname 段名字<br>vmaddr 段的虚拟内存起始地址<br>vmsize 段的虚拟内存大小<br>fileoff 段在文件中的偏移量<br>filesize 段在文件中的大小<br>maxprot 段页面所需要的最高内存保护<br>initprot 段页面初始的内存保护<br>nsects 段中包含 section 的数量<br>flags 其他杂项标志位</p>
<h4 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h4><p>section 的机构如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">struct section &#123; /* <span class="keyword">for</span> 32-bit architectures */</span><br><span class="line">	char		sectname[16];	/* name of this section */</span><br><span class="line">	char		segname[16];	/* segment this section goes <span class="keyword">in</span> */</span><br><span class="line">	uint32_t	addr;		/* memory address of this section */</span><br><span class="line">	uint32_t	size;		/* size <span class="keyword">in</span> bytes of this section */</span><br><span class="line">	uint32_t	offset;		/* file offset of this section */</span><br><span class="line">	uint32_t	align;		/* section alignment (power of 2) */</span><br><span class="line">	uint32_t	reloff;		/* file offset of relocation entries */</span><br><span class="line">	uint32_t	nreloc;		/* number of relocation entries */</span><br><span class="line">	uint32_t	flags;		/* flags (section <span class="built_in">type</span> and attributes)*/</span><br><span class="line">	uint32_t	reserved1;	/* reserved (<span class="keyword">for</span> offset or index) */</span><br><span class="line">	uint32_t	reserved2;	/* reserved (<span class="keyword">for</span> count or sizeof) */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct section_64 &#123; /* <span class="keyword">for</span> 64-bit architectures */</span><br><span class="line">	char		sectname[16];	/* name of this section */</span><br><span class="line">	char		segname[16];	/* segment this section goes <span class="keyword">in</span> */</span><br><span class="line">	uint64_t	addr;		/* memory address of this section */</span><br><span class="line">	uint64_t	size;		/* size <span class="keyword">in</span> bytes of this section */</span><br><span class="line">	uint32_t	offset;		/* file offset of this section */</span><br><span class="line">	uint32_t	align;		/* section alignment (power of 2) */</span><br><span class="line">	uint32_t	reloff;		/* file offset of relocation entries */</span><br><span class="line">	uint32_t	nreloc;		/* number of relocation entries */</span><br><span class="line">	uint32_t	flags;		/* flags (section <span class="built_in">type</span> and attributes)*/</span><br><span class="line">	uint32_t	reserved1;	/* reserved (<span class="keyword">for</span> offset or index) */</span><br><span class="line">	uint32_t	reserved2;	/* reserved (<span class="keyword">for</span> count or sizeof) */</span><br><span class="line">	uint32_t	reserved3;	/* reserved */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>sectname section 名<br>segname 该 section 所属的 segment 名<br>addr 该 section 在内存的启始位置<br>size 该 section 的大小<br>offset 该 section 的文件偏移<br>align 字节大小对齐<br>reloff 重定位入口的文件偏移<br>nreloc 需要重定位的入口数量<br>flags 包含 section 的 type 和 attributes</p>
<p>可以通过 otool –s 查看某 segment 的某个 section：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ otool -s __TEXT __text WeChat</span><br><span class="line">WeChat (architecture armv7):</span><br><span class="line">Contents of (__TEXT,__text) section</span><br><span class="line">0000aff0	af03b5f0 8d04f84d f6444606 f2c070fe </span><br><span class="line">0000b000	f644304d 447871fc 314df2c0 46904479 </span><br><span class="line">0000b010	68096800 680c6800 8000f846 b9955935 </span><br><span class="line">0000b020	70e8f644 304df2c0 68004478 58306800</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="MachOView"><a href="#MachOView" class="headerlink" title="MachOView"></a>MachOView</h3><p>除了用 otool 查看 Mach-O 外，还可以通过 MachOView 可视化工具来查看<br>MachOView下载地址：<a href="http://sourceforge.net/projects/machoview/" target="_blank" rel="noopener">http://sourceforge.net/projects/machoview/</a><br>MachOView源码地址：<a href="https://github.com/gdbinit/MachOView">https://github.com/gdbinit/MachOView</a><br>效果如下：<br><img src="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20preview.jpg" alt=""><br><img src="https://raw.githubusercontent.com/caozhenwei/blog_pic/master/Mach-O%20%E5%AD%A6%E4%B9%A0/mach-o%20preview1.jpg" alt=""></p>
<h3 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h3><p><a href="https://github.com/caozhenwei/document/blob/master/Mach-O-File-Format.pdf">Mach-O-File-Format</a></p>

      </div>
    </div>
  </article>

  <!-- 目录 -->
  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mach-O-结构简单介绍"><span class="nav-text">Mach-O 结构简单介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mach-O-三部分结构详细介绍"><span class="nav-text">Mach-O 三部分结构详细介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Header"><span class="nav-text">Header</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#加载命令"><span class="nav-text">加载命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data"><span class="nav-text">Data</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MachOView"><span class="nav-text">MachOView</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关资料"><span class="nav-text">相关资料</span></a></li></ol>
    
    </div>
  </aside>
</div>

<footer id="footer">
    <p> Powered_by
     <a href="http://hexo.io/" target="_blank">Hexo</a>
     and 
     <a href="https://github.com/caozhenwei/zw_theme" target="_blank">Hexo-theme-zw_theme  
     </a> 
      , copyright &copy; 2018 - 2019 caozhenwei All Rights Reserved.
    </p>
</footer>
    </main>
  </body>
</html>